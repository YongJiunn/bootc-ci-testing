name: bootc-build-postgres

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-postgres:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: ShellCheck all shell scripts
        run: |
          shellcheck $(find . -type f -name "*.sh")

      - name: CRLF check
        run: |
          if grep -R $'\r' build_scripts Containerfile; then
            echo "CRLF line endings detected. Use LF only."
            exit 1
          fi

      - name: Build postgres bootc image
        run: |
          podman build \
            -f Containerfile \
            -t bootc-postgres:test \
            --build-arg VARIANT=postgres \
            --build-arg HARDENED=true \
            --build-arg DEFAULT_PASSWORD=dummy \
            --build-arg BOOTLOADER_PASSWORD=dummy \
            --build-arg POSTGRES_EXPORTER_PASSWORD=dummy \
            --build-arg POSTGRESQL_REPLICATION_PASSWORD=dummy \
            --no-cache \
            .

      - name: Save image as OCI archive
        run: |
          podman save \
            --format oci-archive \
            -o bootc-postgres.tar \
            bootc-postgres:test

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg lsb-release

          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | \
            sudo gpg --dearmor -o /usr/share/keyrings/trivy.gpg

          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] \
            https://aquasecurity.github.io/trivy-repo/deb \
            $(lsb_release -sc) main" | \
            sudo tee /etc/apt/sources.list.d/trivy.list > /dev/null

          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Trivy security gate (HIGH + CRITICAL)
        run: |
          trivy image \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            --ignorefile .trivyignore \
            --no-progress \
            --input bootc-postgres.tar

      - name: Validate Trivy waiver documentation
        run: |
          while read cve; do
            if ! grep -q "$cve" trivy-waiver-documentation.md; then
              echo "CVE $cve is ignored but not documented!"
              exit 1
            fi
          done < .trivyignore

      - name: Generate Trivy report
        if: always()
        run: |
          trivy image \
            --severity HIGH,CRITICAL \
            --ignorefile .trivyignore \
            --format table \
            --output trivy-report.txt \
            --input bootc-postgres.tar

      - name: Upload Trivy report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.txt
