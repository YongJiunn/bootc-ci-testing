name: bootc-build-postgres

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ main ]
    tags:
      - 'v*'

# Required for:
# - GHCR push: packages:write
# - Keyless Cosign: id-token:write (OIDC)
# - Checkout: contents:read
permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  build-postgres:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tooling (podman, shellcheck, prereqs)
        run: |
          sudo apt-get update
          sudo apt-get install -y podman shellcheck wget gnupg lsb-release

      - name: ShellCheck all shell scripts
        run: |
          shellcheck $(find . -type f -name "*.sh")

      - name: CRLF check
        run: |
          if grep -R $'\r' build_scripts Containerfile; then
            echo "CRLF line endings detected. Use LF only."
            exit 1
          fi

      - name: Build postgres bootc image
        run: |
          podman build \
            -f Containerfile \
            -t bootc-postgres:test \
            --build-arg VARIANT=postgres \
            --build-arg HARDENED=true \
            --build-arg DEFAULT_PASSWORD=dummy \
            --build-arg BOOTLOADER_PASSWORD=dummy \
            --build-arg POSTGRES_EXPORTER_PASSWORD=dummy \
            --build-arg POSTGRESQL_REPLICATION_PASSWORD=dummy \
            --no-cache \
            .

      - name: Save image as OCI archive
        run: |
          podman save \
            -o bootc-postgres.tar \
            bootc-postgres:test

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg lsb-release

          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | \
            sudo gpg --dearmor -o /usr/share/keyrings/trivy.gpg

          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] \
            https://aquasecurity.github.io/trivy-repo/deb \
            $(lsb_release -sc) main" | \
            sudo tee /etc/apt/sources.list.d/trivy.list > /dev/null

          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Trivy security gate (HIGH + CRITICAL)
        run: |
          trivy image \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            --ignorefile .trivyignore \
            --no-progress \
            --input bootc-postgres.tar

      - name: Validate Trivy waiver documentation
        run: |
          while read -r cve; do
            # Skip comments and empty lines
            [[ -z "$cve" || "$cve" =~ ^# ]] && continue
            
            # Trim whitespace
            cve=$(echo "$cve" | xargs)
            
            if ! grep -q "$cve" reports/trivy/trivy-waiver-documentation.md; then
              echo "CVE $cve is ignored but not documented in reports/trivy/trivy-waiver-documentation.md!"
              exit 1
            fi
          done < .trivyignore

      - name: Generate Trivy report
        if: always()
        run: |
          trivy image \
            --severity HIGH,CRITICAL \
            --ignorefile .trivyignore \
            --format table \
            --output trivy-report.txt \
            --input bootc-postgres.tar

      - name: Upload Trivy report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.txt

      # -------------------------
      # RELEASE-ONLY: Publish + Sign + ISO
      # -------------------------

      - name: Login to GHCR
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            podman login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Tag image for GHCR (semver + sha)
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          SHA="${GITHUB_SHA::7}"
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

          podman tag bootc-postgres:test "ghcr.io/${OWNER}/bootc-postgres:${VERSION}"
          podman tag bootc-postgres:test "ghcr.io/${OWNER}/bootc-postgres:sha-${SHA}"

      - name: Push image to GHCR
        if: startsWith(github.ref, 'refs/tags/v')
        run: |  
          VERSION="${GITHUB_REF#refs/tags/}"
          SHA="${GITHUB_SHA::7}"
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

          podman push "ghcr.io/${OWNER}/bootc-postgres:${VERSION}"
          podman push "ghcr.io/${OWNER}/bootc-postgres:sha-${SHA}"

      # - name: Install Cosign (keyless)
      #   if: startsWith(github.ref, 'refs/tags/v')
      #   uses: sigstore/cosign-installer@v3

      # - name: Cosign keyless sign (semver + sha tags)
      #   if: startsWith(github.ref, 'refs/tags/v')
      #   env:
      #     COSIGN_EXPERIMENTAL: "true"
      #   run: |
      #     VERSION="${GITHUB_REF#refs/tags/}"
      #     SHA="${GITHUB_SHA::7}"
      #     OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

      #     cosign sign --yes "ghcr.io/${OWNER}/bootc-postgres:${VERSION}"
      #     cosign sign --yes "ghcr.io/${OWNER}/bootc-postgres:sha-${SHA}"

      - name: Pull image for ISO (root namespace)
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE="ghcr.io/${OWNER}/bootc-postgres:${VERSION}"

          sudo podman pull "${IMAGE}"

      - name: Prepare output directory
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          mkdir -p output
          chmod 777 output

      - name: Build ISO (bootc-image-builder)
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE="ghcr.io/${OWNER}/bootc-postgres:${VERSION}"

          mkdir -p output

          sudo podman run --rm \
            --name postgres-bootc-image-builder \
            --tty \
            --privileged \
            --security-opt label=type:unconfined_t \
            -v /var/lib/containers/storage:/var/lib/containers/storage \
            -v "${PWD}/output:/output" \
            -v "${PWD}/image.toml:/config.toml:ro" \
            --label bootc.image.builder=true \
            quay.io/centos-bootc/bootc-image-builder:latest \
            "${IMAGE}" \
            --output /output/bootloader.iso \
            --local \
            --progress verbose \
            --type anaconda-iso \
            --target-arch amd64 \
            --rootfs ext4

      - name: Upload ISO to GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: output/bootloader.iso